# Dockerfile generated by psick_profile::docker::dockerize { '<%= @app %>': }
FROM <%= @real_from %>
<% if @maintainer -%>
MAINTAINER <%= @maintainer %>
<% end -%>

<% if @prepend_lines -%>
<% @prepend_lines.each do |pline| -%>
<%= pline %>
<% end -%>
<% end -%>
<% if @settings['dockerfile_prerequisites'] -%>
<%= @settings['dockerfile_prerequisites'] %>
<% end -%>
<% if @image_os == 'debian' or @image_os == 'ubuntu' -%>
<% if @settings['repo_url'] -%>
RUN echo 'deb <%= @settings['repo_url'] -%> <%= @settings['apt_release'] %> <%= @settings['apt_repos'] %>' > /etc/apt/sources.list.d/<%= @app %>.list
<% if @settings['apt_key_server'] -%>
RUN apt-key add --keyserver <%= @settings['apt_key_server'] %> --recv-key <%= @settings['key'] %>
<% end -%>
<% if @settings['key_url'] -%>
RUN wget -O - <%= @settings['key_url'] %> | apt-key add -
<% end -%>
<% end -%>
RUN apt-get update && \
apt-get install -y --force-yes --no-install-recommends <%= @settings['package_name'] %> && \
<% if @command_mode == 'supervisor' -%>
apt-get install -y --force-yes --no-install-recommends <%= @settings_supervisor['package_name'] %> && \
<% end -%>
rm -rf /var/lib/apt/lists/*
<% end -%>
<% if @image_os == 'redhat' or @image_os == 'centos' -%>
<% if @settings['repo_url'] -%>
RUN echo -e '[<%= @app %>]\nname=<%= @app %> repository\nbaseurl=<%= @settings['repo_url'] -%>\ngpgkey=<%= @settings['key_url'] %>' > /etc/yum.repos.d/<%= @app %>.repo
<% end -%>
<% if @settings['repo_package_url'] -%>
RUN rpm -i <%= @settings['repo_package_url'] %>
<% end -%>
RUN yum install -y epel-release
RUN yum install -y <%= @settings['package_name'] %> <% if @command_mode == 'supervisor' -%><%= @settings_supervisor['package_name'] %><% end -%> && yum clean all
<% end -%>
<% if @image_os == 'alpine' -%>
<% if @settings['package_name'] != '' -%>
RUN echo -e 'http://dl-3.alpinelinux.org/alpine/edge/testing\nhttp://dl-3.alpinelinux.org/alpine/edge/community' >> /etc/apk/repositories
RUN apk --no-cache add <%= @settings['package_name'] %> <% if @command_mode == 'supervisor' -%><%= @settings_supervisor['package_name'] %><% end %>
<% end -%>
<% end -%>

<% if @command_mode == 'supervisor' -%>
<% if @settings_supervisor['conf_dir_path'].to_s.empty?
destfile = @settings_supervisor['config_file_path']
else
destfile = @settings_supervisor['conf_dir_path'] + "/" + @app + "." + @settings_supervisor['config_file_extension']
end -%>
RUN echo -e "[supervisord]\nnodaemon=true\n\n[program:<%= @settings['process_name'] %>]\ncommand=<%= @settings['process_name'] %> <% if @settings['process_extra_name'] -%><%= @settings['process_extra_name'] -%><% end -%> <% if @settings['process_args'] -%><%= @settings['process_args'] %><% end -%> <% if @settings['nodaemon_args'] -%><%= @settings['nodaemon_args'] %><% end -%>" >> <%= destfile %>
<% end -%>

<% if @settings['tcp_port'] -%>
EXPOSE <%= @settings['tcp_port'] %>
<% end -%>

<% if (@settings['data_dir_path'] and @mount_data_dir) or (@settings['log_dir_path'] and @mount_log_dir) -%>
VOLUME <% if @settings['data_dir_path'] and @mount_data_dir -%><%= @settings['data_dir_path'] %><% end -%> <% if @settings['log_dir_path'] and @mount_log_dir -%><%= @settings['log_dir_path'] %> <% end -%>
<% end -%>

<% if @copy_data_on_image -%>
COPY root /
<% end -%>

<% if @command_mode == 'command' %>
ENTRYPOINT [ "<%= @settings['process_name'] %>"<% if @settings['process_extra_name'] -%> , "<%= @settings['process_extra_name'] -%>"<% end -%> <% if @settings['nodaemon_args'] -%> <% commb = '' %> , "<% @settings['nodaemon_args'].split.each do |nd| %><%= commb %>"<%= nd %>"<% commb = ',' %><% end -%><% end -%> ]
<% if @settings['process_args'] -%>
CMD [ <% comma = '' %><% @settings['process_args'].split.each do |ar| %><%= comma %>"<%= ar %>"<% comma = ',' %><% end -%> ]
<% end -%>
<% end -%>
<% if @command_mode == 'supervisor' %>
CMD [ "/usr/bin/<%= @settings_supervisor['process_name'] -%>" , "-n" , "-c" , "<%= @settings_supervisor['config_file_path'] -%>" ]
<% end -%>

<% if @append_lines -%>
<% @append_lines.each do |line| -%>
<%= line %>
<% end -%>
<% end -%>
