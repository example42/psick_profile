# File generated by Puppet
FROM <%= @real_from %>
<% if @maintainer -%>
MAINTAINER <%= @maintainer %>
<% end -%>

<% if @prepend_lines -%>
<% @prepend_lines.each do |pline| -%>
<%= pline %>
<% end -%>
<% end -%>
ENV <%= @env %>
LABEL <%= @label %>
MOUNT <%= @mount %>

<% if @image_os == 'debian' or @image_os == 'ubuntu' -%>
RUN apt-get update -q && \
    apt-get install -y -q wget && \
    wget https://apt.puppetlabs.com/puppetlabs-release-pc1-<%= @image_codename %>.deb -q && \
    dpkg -i puppetlabs-release-pc1-<%= @image_codename %>.deb && \
    rm puppetlabs-release-pc1-<%= @image_codename %>.deb && \
    apt-get update -q && \
    apt-get install --no-install-recommends -y puppet-agent && \
    puppet resource package ruby ensure=present && \  
    puppet resource package deep_merge ensure=present provider=gem && \
    puppet resource package hiera-eyaml ensure=present provider=gem && \
    apt-get clean && \
    rm -rf /var/lib/apt/lists/* \
<% end -%>
<% if @image_os == 'redhat' or @image_os == 'centos' -%>
RUN yum install -y epel-release && \
    rpm -Uvh https://yum.puppetlabs.com/puppetlabs-release-pc1-el-<%= @image_osversion %>.noarch.rpm && \
    puppet resource package ruby ensure=present && \
    puppet resource package deep_merge ensure=present provider=gem && \
    puppet resource package hiera-eyaml ensure=present provider=gem && \
    yum install -y puppet-agent && \
    yum clean all
<% end -%>
<% if @image_os == 'alpine' -%>
RUN echo -e 'http://dl-3.alpinelinux.org/alpine/edge/testing' >> /etc/apk/repositories && \
    echo -e 'http://dl-3.alpinelinux.org/alpine/edge/community' >> /etc/apk/repositories && \
    apk update && \
    apk add shadow ruby less bash && \
    gem install puppet --no-ri --no-rdoc
    puppet resource package ruby ensure=present && \  
    puppet resource package deep_merge ensure=present provider=gem && \
    puppet resource package hiera-eyaml ensure=present provider=gem && \
<% end -%>

RUN cd /opt/puppetlabs/bin &&\
    wget https://github.com/grammarly/rocker/releases/download/1.2.0/rocker-1.2.0-linux_amd64.tar.gz -O - | tar -xz
    
COPY <%= @real_copy %>
RUN true && \
<% if @puppet_facts -%>
<% @puppet_facts.each do |key,val| -%>    
    export FACTER_<%= key %>=<%= val %> && \
<% end -%>
<% end -%>
    <%= @puppet_script %> <%= @puppet_manifest %> <%= @puppet_arguments %>

<% if @expose -%>
EXPOSE <%= @expose %>
<% end -%>

<% if @cmd -%>
CMD <%= @cmd %>
<% end -%>

<% if @append_lines -%>
<% @append_lines.each do |line| -%>
<%= line %>
<% end -%>
<% end -%>
